<script src="resources/node-red-contrib-c8y/configheader.js"></script>
<script type="text/javascript">

    RED.nodes.registerType('notification',{
        category: 'Cumulocity',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            active: {value: true},
            subscription: {
                value:"", required: true,
                validate: RED.validators.typedInput('subscriptionType')
            },
            subscriptionType: {
                value: "Select"
            },
            subscriber: {value:"", required: true},
            c8yconfig: {value:"", type:"c8yconfig", required: true},
            useenv: {value: false}
        },
        // inputs: subscriptionType ==="msg" ? 1 :0,
        inputs: 0,
        icon: "file.png",
        outputs:1,
        label: function() {
            return this.name ||"notification-" + this.subscriber;
        },
        oneditprepare: function () {
                var node = this;
                function getSubscriptions(subs) {
                    $('#node-input-subscription').typedInput({
                    default: 'Select',
                    typeField: $("#node-input-subscriptionType"),
                    types: [
                        'str',
                        {
                            value: "Select",
                            multiple: false,
                            options: subs,
                            showLabel: true
                        }
                    ]
                    });
                }

                if (node.c8yconfig != undefined && node.c8yconfig !=null && node.c8yconfig !=="" ) {
                    $.ajax({
                        url: 'notification/' + node.id +'/getSubscriptions',
                        cache: false,
                        dataType: 'json',
                        method: 'GET',
                        success: function (data) {
                            var subarray = [];
                            data.subscriptions.forEach((sub) => {
                                try {
                                    subarray.push({
                                        value: sub.subscription,
                                        label: sub.subscription,
                                    });
                                } catch (error) {
                                    console.log("error" +  error);
                                }
                            });
                            getSubscriptions(subarray);
                            $('#node-input-subscription').val(node.subscription);
                        },
                        error: function (error) { 
                            console.error("Error: " + error);
                        }
		            });
                }
                
        },
        button: {
            toggle: "active",
            onclick: function() {
                var node = this;
                $.ajax({
                    url: 'notification/' + node.id +'/'+(node.active?"enable":"disable"),
                    cache: false,
                    dataType: 'json',
                    method: 'GET',
                    success: function (data) {
                        console.log("Success: " + JSON.stringify(data));
                    }
		        });
            }
        }
    });
</script>

<script type="text/html" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div id="config-form">
        <div class="form-row">
            <label for="node-input-useenv"><i class="fa fa-tag"></i> Use ENV</label>
            <input type="checkbox" id="node-input-useenv"/>
        </div>
        <div class="form-row" id="c8yconfig-row">
            <label for="node-input-c8yconfig"><i class="fa fa-tag"></i> C8y config</label>
            <input type="text" id="node-input-c8yconfig" placeholder="c8yconfig">
        </div>
    </div>
    <div class="form-row" id="subscriptions">
        <label for="node-input-subscription"><i class="fa fa-tag"></i> Subscription</label>
        <input type="text" id="node-input-subscription">
        <input type="hidden" id="node-input-subscriptionType">
	</div>
    <div class="form-row">
        <label for="node-input-subscriber"><i class="fa fa-tag"></i> Subscriber</label>
        <input type="text" id="node-input-subscriber" placeholder="subscriber">
    </div>
</script>

<script type="text/html" data-help-name="notification">
    <p>A node that creates a subscriber for Notification 2.0 Cumulocity and consumes events.</p>
</script>

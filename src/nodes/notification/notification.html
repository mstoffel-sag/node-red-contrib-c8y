<script src="resources/node-red-contrib-c8y/configheader.js"></script>
<script type="text/javascript">

    RED.nodes.registerType('notification',{
        category: 'Cumulocity',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            c8yconfig: {value:"", type:"c8yconfig", required: true},
            useenv: {value: false},
            subscription: {value:"", required: true},
            subscriber: {value:"", required: true},
            filter: {value:"", required: true},
            filterType: {value: "json"},
            deviceIds: {value: "", required:true},
            deviceIdsType: {value: "json"},
        },
        inputs: 0,
        icon: "file.png",
        outputs:1,
        label: function() {
            return this.name ;
        },
        oneditprepare: function () {
            $('#node-input-deviceIds').typedInput({
                default: 'json',
                typeField: $("#node-input-deviceIdsType"),
                types: ['json']
            });
            $('#node-input-filter').typedInput({
                default: 'json',
                typeField: $("#node-input-filterType"),
                types: ['json']
            });
                // var node = this;
                // if (node.c8yconfig ) {
                //     $.ajax({
                //         url: 'notification/' + node.id +'/getSubscriptions',
                //         cache: false,
                //         dataType: 'json',
                //         method: 'GET',
                //         success: function (data) {
                //             var subarray = [];
                //             data.subscriptions.forEach((sub) => {
                //                 try {
                //                     subarray.push({
                //                         value: sub.subscription,
                //                         label: sub.subscription,
                //                     });
                //                 } catch (error) {
                //                     console.log("error getting subarray.push");
                //                 }
                //             });
                //             getSubscriptions(subarray);
                          
                //         },
                //         error: function (error) { 
                //             console.log("Error: " , error);
                //         }
		        //     });
                // }else{
                //     console.debug("No config found. Skipping.");
                // }
                
        },
    });
</script>

<script type="text/html" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div id="config-form">
        <div class="form-row">
            <label for="node-input-useenv"><i class="fa fa-tag"></i> Use ENV</label>
            <input type="checkbox" id="node-input-useenv"/>
        </div>
        <div class="form-row" id="c8yconfig-row">
            <label for="node-input-c8yconfig"><i class="fa fa-tag"></i> C8y config</label>
            <input type="text" id="node-input-c8yconfig" placeholder="c8yconfig">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-subscription"><i class="fa fa-tag"></i> Subscription</label>
        <input type="text" id="node-input-subscription">
	</div>
    <div class="form-row">
        <label for="node-input-subscriber"><i class="fa fa-tag"></i> Subscriber</label>
        <input type="text" id="node-input-subscriber" placeholder="subscriber">
    </div>
    <div class="form-row">
        <label for="node-input-filter"><i class="fa fa-tag"></i> Filter</label>
        <input type="text" id="node-input-filter" placeholder="">
        <input type="hidden" id="node-input-filterType">
    </div>
    <div class="form-row">
        <label for="node-input-deviceIds"><i class="fa fa-tag"></i> Devices</label>
        <input type="text" id="node-input-deviceIds" placeholder="">
        <input type="hidden" id="node-input-deviceIdsType">
    </div>
</script>

<script type="text/markdown" data-help-name="notification">
A node to subscribe to Cumulocity Notification 2.0 API.

The node needs Cumulocity conection details (Tenant/Base URL) 
and credentials (Username and Password).
Those can be obtained via a configuration (C8y Config Property) or through environment variables.
Using evironment variables comes in handy if your running inside Cumulocity as a microservice. To use them check the Use ENV checkbox. 

### Inputs
: Name (string) :  If not set notification-${subscription}.
: Subscription (string Dropdown| string ) : Existing Notification 2.0 Subscription
: Subscriber (string) : Arbitrary Subscriber Name.

### outputs
: payload (JSON string) : Received Notification 2.0 Message `msg.payload`

### ðŸ”¥ConfigurationðŸ”¥
To get and select subscriptions a two step approach is necessarry.
At first configure the Cumulocity connection (C8y Config) then deploy the flow.
Open the node again and select a subscription. Choose a subscriber name and deploy again.
Now you should get new notifications. 
</script>

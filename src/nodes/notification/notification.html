<script type="text/javascript">
    RED.nodes.registerType('notification',{
        category: 'Cumulocity',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            active: {value: true},
            subscription: {value:"", required: true},
            subscriber: {value:"", required: true},
            c8yconfig: {value:"", type:"c8yconfig", required: true},
            useenv: {value: false}
        },
        inputs:0,
        outputs:1,
        icon: "file.png",
        label: function() {
            return this.name ||"notification-" + this.subscriber;
        },
        oneditprepare: function () {
                var node = this;
                console.log("Sub Selected: " + node.subscription);
                console.log("getSubscriptions " ,node.c8yconfig);

                if (node.c8yconfig != undefined && node.c8yconfig !=null && node.c8yconfig !=="") {
                    $.ajax({
                        url: 'notification/' + node.id +'/getSubscriptions',
                        cache: false,
                        dataType: 'json',
                        method: 'GET',
                        success: function (data) {
                            data.subscriptions.forEach((sub) => {
                                $('<option value="'+ sub.subscription +'">'+ sub.subscription + '</option>').appendTo("#node-input-subscription");
                            });
                            $('#node-input-subscription').val(node.subscription);
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) { 
                            console.error("Error getSubscriptions Status: " + textStatus + " Error: " + errorThrown);
                        }
		            });
                }else{
                    $('#subscriptions').hide();
                }
        },
        button: {
            toggle: "active",
            onclick: function() {
                var node = this;
                console.log("ClICK " ,node.active);
                $.ajax({
                    url: 'notification/' + node.id +'/'+(node.active?"enable":"disable"),
                    cache: false,
                    dataType: 'json',
                    method: 'GET',
                    success: function (data) {
                        console.log("Success: " + JSON.stringify(data));
                    }
		        });
            }
        }
    });
</script>

<script type="text/html" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-useenv"><i class="fa fa-tag"></i> Use ENV</label>
        <input type="checkbox" id="node-input-useenv"/>
    </div>
    <div class="form-row" id="c8yconfig-row">
        <label for="node-input-c8yconfig"><i class="fa fa-tag"></i> C8y config</label>
        <input type="text" id="node-input-c8yconfig" placeholder="c8yconfig">
    </div>
    <div class="form-row" id="subscriptions">
        <label for="node-input-subscription"><i class="fa fa-tag"></i> Subscription</label>
        <select id="node-input-subscription"></select>
	</div>
    <div class="form-row">
        <label for="node-input-subscriber"><i class="fa fa-tag"></i> Subscriber</label>
        <input type="text" id="node-input-subscriber" placeholder="subscriber">
    </div>
</script>

<script type="text/html" data-help-name="notification">
    <p>A node that creates a subscriber for Notification 2.0 Cumulocity and consumes events.</p>
</script>

<script src="resources/node-red-contrib-c8y/configheader.js"></script>
<script type="text/javascript">

    RED.nodes.registerType('notification',{
        category: 'Cumulocity',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            c8yconfig: {value:"", type:"c8yconfig", required: true},
            useenv: {value: false},
            subscription: {value:"", required: true},
            subscriber: {value:"", required: true},

            context: {value:"mo", required: true},
            contextType: {value:"Select", required: true},

            apis: {value:"", required: true},
            apisType: {value:"Select", required: true},

            typeFilter: {value:"", required: false},

            fragmentsToCopy: {value:"", required: false},

            nonPersistent: {value:false, required: true},
            deviceIds: {
                value:"", required: true,
                validate: RED.validators.typedInput('deviceIdsType')},
            deviceIdsType: {value: "Select"},
        },
        inputs: 0,
        icon: "file.png",
        outputs:1,
        label: function() {
            return this.name ||"notification-" + this.subscription;
        },
        oneditprepare: function () {
          console.log("node.deviceIds: " , this.deviceIds);
            $('#node-input-filter').typedInput({
                default: 'json',
                typeField: $("#node-input-filterType"),
                types: ['json']
            });
                var node = this;
                function getDevices(devs) {
                    $('#node-input-context').typedInput({
                        default: 'Select',
                        typeField: $("#node-input-contextType"),
                        types: [
                            'str',
                            {
                                value: "Select",
                                title: "Context",
                                multiple: false,
                                options: [
                                    {value: "mo", label: "ManagedObjects"},
                                    {value: "tenant", label: "Tenant"}
                                ],
                            }
                        ]
                    });
                    $('#node-input-apis').typedInput({
                        default: 'Select',
                        typeField: $("#node-input-apisType"),
                        types: [
                            'str',
                            {
                                value: "Select",
                                title: "APIs",
                                multiple: true,
                                options: [
                                    {value: "*", label: "All APIs"},
                                    {value: "alarms", label: "Alarms"},
                                    {value: "alarmsWithChildren", label: "AlarmsWithChildren"},
                                    {value: "events", label: "Events"},
                                    {value: "eventsWithChildren", label: "EventsWithChildren"},
                                    {value: "measurements", label: "Measurements"},
                                    {value: "managedobjects", label: "Managedobjects"}
                                ],
                                showLabel: true
                            }
                        ]
                    });

                    // Device Selection from backend
                    let options= [];
                    options.includes()
                    devs.forEach(element => {
                        if (node.deviceIds.includes(element.value)) {
                            console.log("is selected addin"+ element.value);
                            element.selected = true
                            
                        }
                    });
                    console.log("Devices", devs);
                    $('#node-input-deviceIds').typedInput({
                    default: 'Select',
                    typeField: $("#node-input-deviceIdsType"),
                    types: [
                        'json',
                        {
                            value: "Select",
                            title: "Devices",
                            multiple: true,
                            options: devs,
                            showLabel: true
                        }
                    ]
                    });
                }
                if (node.c8yconfig ) {
                    $.ajax({
                        url: 'notification/' + node.id +'/getDevices',
                        cache: false,
                        dataType: 'json',
                        method: 'GET',
                        success: function (data) {
                            console.log("Devices:"  ,data);
                            getDevices(data);
                        },
                        error: function (error) { 
                            console.log("Error: " , error);
                        }
		            });
                }else{
                    console.debug("No config found. Skipping.");
                }
                
        },
    });
</script>

<script type="text/html" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div id="config-form">
        <div class="form-row">
            <label for="node-input-useenv"><i class="fa fa-tag"></i> Use ENV</label>
            <input type="checkbox" id="node-input-useenv"/>
        </div>
        <div class="form-row" id="c8yconfig-row">
            <label for="node-input-c8yconfig"><i class="fa fa-tag"></i> C8y config</label>
            <input type="text" id="node-input-c8yconfig" placeholder="c8yconfig">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-subscription"><i class="fa fa-tag"></i> Subscription</label>
        <input type="text" id="node-input-subscription">
	</div>
    <div class="form-row">
        <label for="node-input-subscriber"><i class="fa fa-tag"></i> Subscriber</label>
        <input type="text" id="node-input-subscriber" placeholder="subscriber">
    </div>
    <div class="form-row">
        <label for="node-input-nonPersistent"><i class="fa fa-tag"></i> nonPersistent</label>
        <input type="checkbox" id="node-input-nonPersistent"/>
    </div>
    <div class="form-row">
        <label for="node-input-context"><i class="fa fa-tag"></i> Context</label>
        <input type="text" id="node-input-context" placeholder="">
        <input type="hidden" id="node-input-contextType">
    </div>
    <div class="form-row">
        <label for="node-input-apis"><i class="fa fa-tag"></i> APIs</label>
        <input type="text" id="node-input-apis" placeholder="">
        <input type="hidden" id="node-input-apisType">
    </div>
    <div class="form-row">
        <label for="node-input-deviceIds"><i class="fa fa-tag"></i> Devices</label>
        <input type="text" id="node-input-deviceIds" placeholder="">
        <input type="hidden" id="node-input-deviceIdsType">
    </div>
    <div class="form-row">
        <label for="node-input-typeFilter"><i class="fa fa-tag"></i> Type Filter</label>
        <input type="text" id="node-input-typeFilter" placeholder="c8y_Temperature or c8y_Pressure">
    </div>
    <div class="form-row">
        <label for="node-input-fragmentsToCopy"><i class="fa fa-tag"></i> Fragments To Copy</label>
        <input type="text" id="node-input-fragmentsToCopy" placeholder="c8y_Temperature,c8y_Pressure">
    </div>
</script>

<script type="text/markdown" data-help-name="notification">
A node to subscribe to Cumulocity Notification 2.0 API.

The node needs Cumulocity conection details (Tenant/Base URL) 
and credentials (Username and Password).
Those can be obtained via a configuration (C8y Config Property) or through environment variables.
Using evironment variables comes in handy if your running inside Cumulocity as a microservice. To use them check the Use ENV checkbox. 

### Inputs
: Name (string) :  If not set notification-${subscription}.
: Subscription (string Dropdown| string ) : Notification 2.0 Subscription name
: Subscriber (string) : Arbitrary Subscriber Name.
: nonPersistent (boolean) : Persistence of the subscription filter.
: Context (string) : ManagedObjects or Tenant.
: APIs (string) : Which APIs to subscribe to.
: Devices (Dropdown | comma seperated strings) : Which Mo to subscribe to.
: TypeFilter (string odata expression) : Which Type to subscribe to .
: Fragments to copy (comma seperated strings) : Which fragments to copy.

### outputs
: payload (JSON string) : Received Notification 2.0 Message `msg.payload`

### ðŸ”¥ConfigurationðŸ”¥
To get and select devices a two step approach is necessarry.
At first configure the Cumulocity connection (C8y Config) then deploy the flow.
Open the node again and select a the available devices. Select devices  and deploy again.
Now you should get new notifications. 
</script>

<script src="resources/node-red-contrib-c8y/configheader.js"></script>
<script type="text/javascript">

    RED.nodes.registerType('notification',{
        category: 'Cumulocity',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            active: {value: true},
            subscription: {
                value:"", required: true,
                validate: function(v){

                    const sub = $('#node-input-subscription').val();
                    if (sub == "nosub") {
                        return false;
                    }else{
                        return RED.validators.typedInput('subscriptionType')(v);
                    }
                }
            },
            subscriptionType: {
                value: "Select"
            },
            subscriber: {value:"", required: true},
            c8yconfig: {value:"", type:"c8yconfig", required: true},
            useenv: {value: false}
        },
        inputs: 0,
        icon: "file.png",
        outputs:1,
        label: function() {
            return this.name ||"notification-" + this.subscription;
        },
        oneditprepare: function () {

                var node = this;
                console.log("Node: " ,node);
                console.log("node.subscription: " + node.subscription);
                console.log("#node-input-subscription).val()subhtml val " + $("#node-input-subscription").val());
                
                function getSubscriptions(subs) {
                    console.log("Received Subs:" , subs);
                    $('#node-input-subscription').typedInput({
                        default: 'Select',
                        typeField: $("#node-input-subscriptionType"),
                        types: [
                            'str',
                            {
                                value: "Select",
                                multiple: false,
                                options: subs.some(a => typeof a == 'object') ? subs : [{value:"nosub", label: "No subscription found" }],
                                showLabel: true
                            }
                        ]
                    });
                    if (subs.some(a => typeof a == 'object')) {
                        if (node.subscription) {
                                if (subs.find(e => e.value == node.subscription)){
                                    console.log("Found Sub in array selecting it");
                                    $('#node-input-subscription').val(node.subscription);
                                }else{
                                    console.log("Sub selected Not Found Sub in Array try to set to first " +subs[0].value);
                                    node.subscription = subs[0].value;
                                    $('#node-input-subscription').val(subs[0].value);
                                    RED.nodes.dirty(true);
                                }
                        }else{
                            console.log("No subscription selected using first found");
                            node.subscription = subs[0].value;
                            $('#node-input-subscription').val(subs[0].value);
                            RED.nodes.dirty(true);
                        }
                    }else{
                        console.log("no subscription found. Remove node.subscripiton");
                        //$('#node-input-subscription').text("No Subscriptions Found");
                        node.subscription = "nosub";
                        RED.nodes.dirty(true);
                    }
                    
                    console.log("subhtml val " + $("#node-input-subscription").val());
                    console.log("node.subscription: " + node.subscription);
                }
                
                if (node.c8yconfig ) {
                    $.ajax({
                        url: 'notification/' + node.id +'/getSubscriptions',
                        cache: false,
                        dataType: 'json',
                        method: 'GET',
                        success: function (data) {
                            var subarray = [];
                            data.subscriptions.forEach((sub) => {
                                try {
                                    subarray.push({
                                        value: sub.subscription,
                                        label: sub.subscription,
                                    });
                                } catch (error) {
                                    console.log("error getting subarray.push");
                                }
                            });
                            getSubscriptions(subarray);
                          
                        },
                        error: function (error) { 
                            console.log("Error: " , error);
                        }
		            });
                }else{
                    console.debug("No config found. Skipping.");
                }
                
        },
        // button: {
        //     toggle: "active",
        //     onclick: function() {
        //         var node = this;
        //         $.ajax({
        //             url: 'notification/' + node.id +'/'+(node.active?"enable":"disable"),
        //             cache: false,
        //             dataType: 'json',
        //             method: 'GET',
        //             success: function (data) {
        //                 console.log("Success: " + JSON.stringify(data));
        //             }
		//         });
        //     }
        // }
    });
</script>

<script type="text/html" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div id="config-form">
        <div class="form-row">
            <label for="node-input-useenv"><i class="fa fa-tag"></i> Use ENV</label>
            <input type="checkbox" id="node-input-useenv"/>
        </div>
        <div class="form-row" id="c8yconfig-row">
            <label for="node-input-c8yconfig"><i class="fa fa-tag"></i> C8y config</label>
            <input type="text" id="node-input-c8yconfig" placeholder="c8yconfig">
        </div>
    </div>
    <div class="form-row" id="subscriptions">
        <label for="node-input-subscription"><i class="fa fa-tag"></i> Subscription</label>
        <input type="text" id="node-input-subscription">
        <input type="hidden" id="node-input-subscriptionType">
	</div>
    <div class="form-row">
        <label for="node-input-subscriber"><i class="fa fa-tag"></i> Subscriber</label>
        <input type="text" id="node-input-subscriber" placeholder="subscriber">
    </div>
</script>

<script type="text/markdown" data-help-name="notification">
A node to subscribe to Cumulocity Notification 2.0 API.

The node needs Cumulocity conection details (Tenant/Base URL) 
and credentials (Username and Password).
Those can be obtained via a configuration (C8y Config Property) or through environment variables.
Using evironment variables comes in handy if your running inside Cumulocity as a microservice. To use them check the Use ENV checkbox. 

### Inputs
: Name (string) :  If not set notification-${subscription}.
: Subscription (string Dropdown| string ) : Existing Notification 2.0 Subscription
: Subscriber (string) : Arbitrary Subscriber Name.

### outputs
: payload (JSON string) : Received Notification 2.0 Message `msg.payload`

### ðŸ”¥ConfigurationðŸ”¥
To get and select subscriptions a two step approach is necessarry.
At first configure the Cumulocity connection (C8y Config) then deploy the flow.
Open the node again and select a subscription. Choose a subscriber name and deploy again.
Now you should get new notifications. 
</script>
